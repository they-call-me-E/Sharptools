<!-- Do not edit below -->
<script type="application/json" id="tile-settings">
{
  "schema": "0.2.0",
  "settings": [
    {"name": "mToken", "label": "Mapbox Access Token", "type": "STRING"},
    {"type": "STRING", "name": "mLat", "label": "Map Zone Latitude "},
    {"type": "STRING", "name": "mLon", "label": "Map Zone Longitude "},
    {
      "name": "mZoom",
      "label": "Map Zone Zoom Level (0-22) 0 = Zoomed Out, 22 = Zoomed In",
      "type": "NUMBER"
    },
    {"type": "NUMBER", "name": "wStyle", "label": "Weather Style (0-11)"},
    {"type": "NUMBER", "name": "mStyle", "label": "Map Style (1: Streets, 2: Light, 3: Dark, 4: Satellite)"}
  ],
  "name": "Rain Viewer",
  "dimensions": {"height": 3, "width": 3}
}
</script>
<!-- Do not edit above -->

<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1,maximum-scale=1">
<script src="//cdn.sharptools.io/js/custom-tiles.js"></script>
<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.3.1/mapbox-gl.js"></script>
<link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.3.1/mapbox-gl.css" rel="stylesheet">

<div id="map" style="position: absolute; top: 0px; bottom: 0px; width: 100%;"></div>
<script>
  var mLat = 35;
  var mLon = -83;
  var mZoom = 5;
  var radarFrames = [];
  var currentFrameIndex = 0;
  var mToken;
  var wStyle = 1;
  var mStyle = "mapbox://styles/mapbox/dark-v11";

  stio.ready((data) => {
    console.log("Starting Ecobee Init [shortyyy]");
    if (data.settings.mToken) {
      mToken = data.settings.mToken;

      // Convert lat/lon from strings
      if (typeof data.settings.mLat === 'string') mLat = parseFloat(data.settings.mLat);
      if (typeof data.settings.mLon === 'string') mLon = parseFloat(data.settings.mLon);
      if (isNaN(mLat) || isNaN(mLon)) {
        console.error('Error: Invalid mLat or mLon. Ensure they are valid numbers.');
        return;
      }

      // Zoom, style, etc.
      mZoom = data.settings.mZoom || mZoom;
      wStyle = data.settings.wStyle || wStyle;

      // Map style
      if (data.settings.mStyle == 1) { mStyle = "mapbox://styles/mapbox/streets-v12"; }
      if (data.settings.mStyle == 2) { mStyle = "mapbox://styles/mapbox/light-v11"; }
      if (data.settings.mStyle == 3) { mStyle = "mapbox://styles/mapbox/dark-v11"; }
      if (data.settings.mStyle == 4) { mStyle = "mapbox://styles/mapbox/satellite-v9"; }

      console.log('Token Loaded:', mToken);
      console.log('Latitude:', mLat, 'Longitude:', mLon);
      console.log('Weather Style:', wStyle);
      console.log('Map Style URL:', mStyle);

      mapboxgl.accessToken = mToken;
      initializeMap();
    }
  });

  function initializeMap() {
    const map = new mapboxgl.Map({
      container: 'map',
      style: mStyle,
      center: [mLon, mLat],
      zoom: mZoom
    });

    new mapboxgl.Marker().setLngLat([mLon, mLat]).addTo(map);
    window.map = map;

    map.on('load', async () => {
      await fetchRadarData();
      animateRadar();
      setInterval(fetchRadarData, 300000);
    });
  }

  async function fetchRadarData() {
    try {
      const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
      const apiData = await response.json();
      // fill radarFrames from .past array
      radarFrames = apiData.radar.past.map(frame => (
        `${apiData.host}${frame.path}/256/{z}/{x}/{y}/${wStyle}/1_1.png`
      ));
      console.log('Radar Frames Loaded:', radarFrames);
    } catch (error) {
      console.error('Error fetching radar data:', error);
    }
  }

  // We'll create 3 layers in a round-robin, updating the tile each time so all frames are used.

  var totalLayers = 3;
  var activeLayerIndex = 0; // which layer is visible now
  var layersSetup = false;  // track if we've created the 3 layers

  function setupThreeLayers() {
    // If no frames, skip
    if (radarFrames.length === 0) return;

    for (let i=0; i<totalLayers; i++) {
      // Start each layer with a valid frame or frame[0]
      const initFrame = radarFrames[Math.min(i, radarFrames.length -1)] || radarFrames[0];
      map.addSource(`radarSource${i}`, {
        type: 'raster',
        tiles: [initFrame],
        tileSize: 256
      });
      map.addLayer({
        id: `radarLayer${i}`,
        type: 'raster',
        source: `radarSource${i}`,
        paint: { 'raster-opacity': (i===0 ? 1 : 0) }
      });
    }
    activeLayerIndex = 0;
    layersSetup = true;
  }

  function animateRadar() {
    if (radarFrames.length < 2) return;

    // If we haven't set up 3 layers yet, do so
    if (!layersSetup) {
      setupThreeLayers();
      // Wait a moment for user to see the first frame
      setTimeout(cycleFrame, 1000);
    } else {
      // we've already set them up, continue cycle
      cycleFrame();
    }
  }

  function cycleFrame() {
    if (radarFrames.length < 2) return;

    const nextFrameIndex = (currentFrameIndex + 1) % radarFrames.length;

    // The next layer index in [0,1,2]
    const nextLayerIndex = (activeLayerIndex + 1) % totalLayers;

    // Identify layer IDs
    const activeLayerId = `radarLayer${activeLayerIndex}`;
    const newLayerId    = `radarLayer${nextLayerIndex}`;
    const newSourceId   = `radarSource${nextLayerIndex}`;

    // Update the next layer's tile to the upcoming frame
    map.getSource(newSourceId).tiles = [ radarFrames[nextFrameIndex] ];
    map.getSource(newSourceId)._tiles = {}; // force reload
    // Make sure it's at 0 opacity
    map.setPaintProperty(newLayerId, 'raster-opacity', 0);

    // We'll fade out old (1->0), fade in new(0->1)
    let step = 0;
    const steps = 20; // 0.5s fade
    const stepMS = 40;

    const fadeInterval = setInterval(()=> {
      step++;
      const fraction = step / steps; // 0..1

      map.setPaintProperty(activeLayerId, 'raster-opacity', 1 - fraction);
      map.setPaintProperty(newLayerId,   'raster-opacity', fraction);

      if (step>=steps) {
        clearInterval(fadeInterval);
        currentFrameIndex = nextFrameIndex;
        // new layer becomes active
        activeLayerIndex = nextLayerIndex;
        // hide old layer
        map.setPaintProperty(activeLayerId, 'raster-opacity', 0);

        console.log(`Now showing frame index ${currentFrameIndex}:`, radarFrames[currentFrameIndex]);

        // after 0.5s, show next
        setTimeout(cycleFrame, 500);
      }
    }, stepMS);
  }
</script>
