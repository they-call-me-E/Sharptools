<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FlipBoard Stage Editor (Firestore Realtime + WebView Safe)</title>
<style>
  :root{
    --bg:#0b0c10;
    --panel:#12141b;
    --panel2:#0f1117;
    --edge:rgba(255,255,255,.10);
    --edge2:rgba(255,255,255,.06);
    --text:#e8e8ef;
    --muted:rgba(232,232,239,.65);
    --accent:#3fb1ce;
    --danger:#ff4d4d;
    --ok:#4dd285;

    --radius:14px;
    --pad:14px;
    --gap:12px;

    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    background:linear-gradient(180deg, #0b0c10, #07080c);
    color:var(--text);
    font-family:var(--sans);
  }

  header{
    padding:14px 18px;
    border-bottom:1px solid var(--edge2);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  header .title{
    font-weight:800;
    letter-spacing:.2px;
  }
  header .meta{
    font-size:12px;
    color:var(--muted);
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
  }
  header .pill{
    border:1px solid var(--edge2);
    background:rgba(255,255,255,.03);
    padding:6px 10px;
    border-radius:999px;
  }
  header .pill b{color:var(--text)}
  header .meta .dirty{
    color:#ffd27a;
    border-color:rgba(255,210,122,.35);
  }

  .workspace{
    display:grid;
    grid-template-rows:auto 1fr;
    gap:12px;
    padding:14px;
    min-height: calc(100vh - 57px);
  }

  .app{
    display:grid;
    grid-template-columns: 320px 8px 1fr; /* left | splitter | right */
    gap:0;
    min-height: 520px;
  }

  .splitter{
    cursor: col-resize;
    background: rgba(255,255,255,.03);
    border-left: 1px solid rgba(255,255,255,.06);
    border-right: 1px solid rgba(255,255,255,.06);
  }
  .splitter:hover{ background: rgba(63,177,206,.10); }

  .left{
    border-right:none;
    background:rgba(0,0,0,.18);
    padding:var(--pad);
    display:flex;
    flex-direction:column;
    gap:var(--gap);
    min-width:240px;
  }

  .right{
    padding:var(--pad);
    display:flex;
    flex-direction:column;
    gap:var(--gap);
    background: rgba(0,0,0,.10);
  }

  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--edge2);
    border-radius:var(--radius);
    padding:12px;
  }
  .panel h3{
    margin:0 0 8px 0;
    font-size:12px;
    letter-spacing:.6px;
    text-transform:uppercase;
    color:var(--muted);
  }

  .globalBar{
    border-radius:var(--radius);
  }
  .globalRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:flex-end;
  }

  .row{
    display:flex;
    gap:8px;
    align-items:center;
  }

  button{
    appearance:none;
    border:1px solid var(--edge2);
    background:rgba(255,255,255,.04);
    color:var(--text);
    padding:9px 10px;
    border-radius:12px;
    cursor:pointer;
    font-weight:700;
    font-size:13px;
    line-height:1;
    transition:transform .06s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
  }
  button:hover{ background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.14);}
  button:active{ transform:translateY(1px); }
  button.primary{
    border-color:rgba(63,177,206,.45);
    background:rgba(63,177,206,.14);
  }
  button.danger{
    border-color:rgba(255,77,77,.40);
    background:rgba(255,77,77,.12);
  }
  button:disabled{
    opacity:.45;
    cursor:not-allowed;
  }

  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width:180px;
  }
  .field label{
    font-size:11px;
    color:var(--muted);
    letter-spacing:.4px;
    text-transform:uppercase;
  }

  input[type="text"], select, input[type="number"]{
    width:100%;
    background:rgba(0,0,0,.22);
    border:1px solid var(--edge2);
    color:var(--text);
    padding:10px 10px;
    border-radius:12px;
    outline:none;
    font-size:14px;
  }
  input[type="text"]:focus, select:focus, input[type="number"]:focus{
    border-color:rgba(63,177,206,.5);
  }
  .field.tiny{min-width:120px}

  .toggle{
    display:flex;
    gap:8px;
    align-items:center;
    padding:10px 12px;
    border:1px solid var(--edge2);
    background:rgba(0,0,0,.20);
    border-radius:12px;
    height:40px;
    user-select:none;
  }
  .toggle input{ transform:scale(1.1); }
  .toggle span{
    font-size:13px;
    color:var(--text);
    font-weight:800;
  }

  .hint{
    font-size:12px;
    color:var(--muted);
  }
  .mono{ font-family:var(--mono); }

  /* Stages panel */
  .stagesPanel{
    display:flex;
    flex-direction:column;
    gap:8px;
    height: 100%;
  }
  .dragHint{
    font-size:11px;
    color:var(--muted);
    margin-top:2px;
  }
  .sectionTitle{
    font-size:11px;
    color:var(--muted);
    letter-spacing:.4px;
    text-transform:uppercase;
    margin: 10px 0 6px;
  }
  .list{
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .stageItem{
    border:1px solid var(--edge2);
    background:rgba(0,0,0,.18);
    border-radius:12px;
    padding:10px 10px;
    display:flex;
    flex-direction:column;
    gap:4px;
    cursor:pointer;
  }
  .stageItem:hover{ border-color:rgba(255,255,255,.16); background:rgba(0,0,0,.24); }
  .stageItem.selected{
    border-color:rgba(63,177,206,.55);
    background:rgba(63,177,206,.10);
  }

  .stageTop{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
  }
  .stageName{
    font-weight:900;
    font-size:13px;
    line-height:1.2;
  }
  .stageKey{
    font-size:11px;
    color:var(--muted);
    font-family:var(--mono);
  }
  .badges{
    display:flex;
    gap:6px;
    align-items:center;
  }
  .badge{
    font-size:10px;
    padding:4px 7px;
    border-radius:999px;
    border:1px solid var(--edge2);
    color:var(--muted);
    white-space:nowrap;
    text-transform:uppercase;
    letter-spacing:.3px;
  }
  .badge.dynamic{ border-color:rgba(63,177,206,.40); color:rgba(63,177,206,.95); background:rgba(63,177,206,.10); }
  .badge.oneshot{ border-color:rgba(255,210,122,.45); color:#ffd27a; background:rgba(255,210,122,.10); }

  .stageItem[draggable="true"]{ cursor:grab; user-select:none; }
  .stageItem.dragging{ opacity:.6; border-style:dashed; }
  .dropTarget{ outline:2px dashed rgba(63,177,206,.6); outline-offset:2px; }

  .stageActionsBottom{
    margin-top:auto;
    padding-top:12px;
    border-top:1px solid var(--edge2);
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }

  /* Editor window */
  .editor{
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.10);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    border-radius:var(--radius);
    padding:14px;
    min-height: 420px;
  }

  .editorHeader{
    display:flex;
    gap:12px;
    align-items:flex-end;
    flex-wrap:wrap;
    justify-content:space-between;
    border-bottom:1px solid var(--edge2);
    padding-bottom:12px;
    margin-bottom:12px;
  }
  .editorHeader .fields{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:flex-end;
  }
  .field.inlineSmall{min-width:140px}

  .rows{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:10px;
  }

  .lineRow{
    display:grid;
    grid-template-columns: 64px 1fr 70px;
    gap:10px;
    align-items:center;
  }
  .lineRow .lbl{
    font-size:12px;
    color:var(--muted);
    font-family:var(--mono);
  }
  .lineRow input{
    font-family:var(--mono);
    letter-spacing:.2px;
  }
  .lineRow .count{
    text-align:right;
    font-size:12px;
    color:var(--muted);
    font-family:var(--mono);
  }

  .flashOver{
    border-color: rgba(255,77,77,.8) !important;
    box-shadow: 0 0 0 3px rgba(255,77,77,.15);
  }

  .footerBar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-top:14px;
    padding-top:12px;
    border-top:1px solid var(--edge2);
    flex-wrap:wrap;
  }
  .split{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  .toast{
    position:fixed;
    bottom:16px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,.75);
    border:1px solid var(--edge2);
    color:var(--text);
    padding:10px 12px;
    border-radius:999px;
    font-size:13px;
    opacity:0;
    pointer-events:none;
    transition:opacity .2s ease, transform .2s ease;
  }
  .toast.show{
    opacity:1;
    transform:translateX(-50%) translateY(-4px);
  }

  @media (max-width: 900px){
    .workspace{ padding: 10px; }
    .app{ grid-template-columns: 1fr; }
    .splitter{ display:none; }
  }

  /* Status pill states (green/yellow/red) */
  .pill.ok {
    color: var(--ok);
    border-color: rgba(77,210,133,.45);
    background: rgba(77,210,133,.12);
  }
  .pill.warn {
    color: #ffd27a;
    border-color: rgba(255,210,122,.45);
    background: rgba(255,210,122,.12);
  }
  .pill.err {
    color: var(--danger);
    border-color: rgba(255,77,77,.45);
    background: rgba(255,77,77,.12);
  }
</style>
</head>
<body>

<header>
  <div class="title">FlipBoard — Split-Flap Stage Editor</div>
  <div class="meta">
    <div class="pill"><b>Cols:</b> <span id="colsVal">—</span></div>
    <div class="pill"><b>Rows:</b> <span id="rowsVal">—</span></div>
    <div class="pill"><b>Dwell:</b> <span id="dwellVal">—</span></div>

    <div class="pill"><b>Source:</b> <span id="sourceVal">—</span></div>
    <div class="pill"><b>Status:</b> <span id="statusVal">—</span></div>

    <div class="pill" id="dirtyPill" style="display:none;"><b>Unsaved changes</b></div>
  </div>
</header>

<div class="workspace" id="workspace">

  <div class="globalBar panel">
    <h3>Dashboard Settings</h3>

    <div class="globalRow">
      <div class="toggle">
        <input type="checkbox" id="rotationEnabled" />
        <span>Rotation Enabled</span>
      </div>

      <div class="field tiny">
        <label for="rotationDwell">Dwell (ms)</label>
        <input type="number" id="rotationDwell" min="0" step="100" />
      </div>

      <div class="field tiny">
        <label for="gridCols">Columns</label>
        <input type="number" id="gridCols" min="1" step="1" />
      </div>

      <div class="field tiny">
        <label for="gridRows">Rows</label>
        <input type="number" id="gridRows" min="1" step="1" />
      </div>

      <div class="field" style="min-width:260px;flex:1;">
        <label for="metaDescription">Description</label>
        <input type="text" id="metaDescription" placeholder="Stage pack description" />
      </div>
    </div>
  </div>

  <div class="app" id="appSplit">
    <aside class="left" id="leftPane">
      <div class="panel stagesPanel">
        <h3>Stages</h3>

        <div class="dragHint">Drag to reorder the rotation list.</div>

        <div class="sectionTitle">In Rotation</div>
        <div id="rotationList" class="list sortable" aria-label="Rotation order list"></div>

        <div class="sectionTitle" style="margin-top:12px;">Not in Rotation</div>
        <div id="otherList" class="list" aria-label="Other stages list"></div>

        <div class="stageActionsBottom">
          <button class="primary" id="btnAddStage">+ Add Stage</button>
          <button class="danger" id="btnRemoveStage" disabled>Remove</button>

          <button id="btnMoveUp" disabled title="Move selected stage up in rotation">▲</button>
          <button id="btnMoveDown" disabled title="Move selected stage down in rotation">▼</button>

          <div style="flex:1;"></div>
          <button id="btnAddToRotation" disabled>Add</button>
          <button id="btnRemoveFromRotation" disabled>Remove</button>
        </div>
      </div>

      <div class="panel">
        <h3>File</h3>
        <div class="row" style="flex-wrap:wrap;">
          <button id="btnLoad">Load (Dummy)</button>
          <button id="btnExport">Copy JSON</button>
        </div>
        <div class="hint" style="margin-top:10px;">
          Canonical store is Firestore. The Load button is intentionally dummy-only for quick local testing.
        </div>
      </div>
    </aside>

    <div class="splitter" id="splitter" title="Drag to resize"></div>

    <main class="right" id="rightPane">
      <div class="editor" id="editor">
        <div class="editorHeader">
          <div class="fields">
            <div class="field">
              <label for="stageKey">Stage Key (ID)</label>
              <input id="stageKey" type="text" disabled />
            </div>

            <div class="field">
              <label for="stageName">Stage Name</label>
              <input id="stageName" type="text" placeholder="Friendly name" />
            </div>

            <div class="field inlineSmall">
              <label for="stageType">Type</label>
              <select id="stageType">
                <option value="static">static</option>
                <option value="dynamic">dynamic</option>
              </select>
            </div>

            <div class="field inlineSmall" id="sourceWrap" style="display:none;">
              <label for="stageSource">Source</label>
              <input id="stageSource" type="text" placeholder="openweather_onecall" />
            </div>

            <div class="toggle" title="If enabled, this stage should run once when triggered (not part of normal rotation).">
              <input type="checkbox" id="stageOneShot" />
              <span>One-shot</span>
            </div>
          </div>

          <div class="split">
            <button class="primary" id="btnSave" disabled>Save</button>
            <button id="btnCancel" disabled>Cancel</button>
          </div>
        </div>

        <div class="hint">
          Rows are padded to <span class="mono" id="colsHint">—</span> columns on save.
          Inputs accept max <span class="mono" id="colsHint2">—</span> chars. Pasting beyond the limit will flash red.
        </div>

        <div class="rows" id="rowsContainer"></div>

        <div class="footerBar">
          <div class="hint">
            Friendly name is for the editor. Engine should use stage keys (IDs).
          </div>
          <div class="split">
            <button id="btnPadAll">Pad all rows</button>
            <button id="btnTrimAll">Trim all rows</button>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ============================================================
     Firebase Firestore + Anonymous Auth (WebView-safe, matches Flipboard)
     Provides:
       window.loadStagePack()
       window.saveStagePack(pack)
       window.subscribeStagePack(cb) -> unsubscribe()
       window.__flipboardFirestoreReady
       window.__flipboardLastSource
============================================================ -->
<script type="module">
  window.__flipboardFirestoreError = null;
  window.__flipboardLastSource = "—";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    initializeFirestore,
    doc,
    getDocFromServer,
    getDocFromCache,
    getDoc,
    setDoc,
    serverTimestamp,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getAuth,
    signInAnonymously,
    setPersistence,
    browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBMeYQiNcfhkFVtmbKAbDnFILfUz3nLY50",
    authDomain: "flipboard-937e3.firebaseapp.com",
    projectId: "flipboard-937e3",
    storageBucket: "flipboard-937e3.firebasestorage.app",
    messagingSenderId: "926200267004",
    appId: "1:926200267004:web:1ee00c4d344f670b775779"
  };

  const COLLECTION = "flipboard";
  const DOC_ID = "stagePack";
  const FIELD = "data";

  window.__flipboardFirestoreReady = (async () => {
    try {
      const app = initializeApp(firebaseConfig);

      // ✅ Match Flipboard display: Android/WebView safe transport
      const db = initializeFirestore(app, {
        experimentalForceLongPolling: true,
        useFetchStreams: false
      });

      const auth = getAuth(app);
      try { await setPersistence(auth, browserLocalPersistence); } catch(_) {}
      await signInAnonymously(auth);

      console.log("[EDITOR FIRESTORE] AUTH UID:", auth.currentUser?.uid || "(none)");

      const ref = doc(db, COLLECTION, DOC_ID);

      const parseDoc = (snap, label) => {
        if (!snap.exists()) throw new Error(`Doc not found (${label}).`);
        const raw = snap.get(FIELD);
        if (typeof raw !== "string" || !raw.trim()) throw new Error(`Field "data" missing (${label}).`);
        return JSON.parse(raw);
      };

      window.loadStagePack = async function loadStagePack(){
        // 1) server
        try{
          const snap = await getDocFromServer(ref);
          window.__flipboardLastSource = "firestore:server";
          console.log("[EDITOR FIRESTORE] got doc from SERVER");
          return parseDoc(snap, "server");
        }catch(e1){
          console.warn("[EDITOR FIRESTORE] server failed, trying CACHE:", e1?.code || e1?.message || e1);
        }

        // 2) cache
        try{
          const snap = await getDocFromCache(ref);
          window.__flipboardLastSource = "firestore:cache";
          console.log("[EDITOR FIRESTORE] got doc from CACHE");
          return parseDoc(snap, "cache");
        }catch(e2){
          console.warn("[EDITOR FIRESTORE] cache failed, trying DEFAULT:", e2?.code || e2?.message || e2);
        }

        // 3) default
        const snap = await getDoc(ref);
        window.__flipboardLastSource = "firestore:default";
        console.log("[EDITOR FIRESTORE] got doc from DEFAULT getDoc()");
        return parseDoc(snap, "default");
      };

      window.saveStagePack = async function saveStagePack(pack) {
        // Stored exactly like Flipboard display expects: JSON string in FIELD
        const json = JSON.stringify(pack);

        // Simple version bump (optional, but handy)
        let nextVersion = 1;
        try{
          const snap = await getDoc(ref);
          if (snap.exists()) {
            const v = snap.get("version");
            nextVersion = (typeof v === "number" && isFinite(v)) ? (v + 1) : 1;
          }
        }catch(_){}

        await setDoc(ref, {
          [FIELD]: json,
          version: nextVersion,
          updatedAt: serverTimestamp()
        }, { merge: true });

        window.__flipboardLastSource = "firestore:server";
        return { version: nextVersion };
      };

      // ✅ Realtime updates (cache->server transition visible)
      window.subscribeStagePack = function subscribeStagePack(cb){
        if (typeof cb !== "function") throw new Error("subscribeStagePack(cb) requires a callback");

        console.log("[EDITOR FIRESTORE] subscribing to realtime updates…");

        const unsub = onSnapshot(ref, { includeMetadataChanges: true }, (snap) => {
          try{
            const fromCache = !!snap.metadata?.fromCache;
            const src = fromCache ? "firestore:realtime-cache" : "firestore:realtime-server";
            window.__flipboardLastSource = src;

            const pack = parseDoc(snap, src);
            cb(pack, src);
          }catch(err){
            console.error("[EDITOR FIRESTORE] snapshot parse error:", err);
          }
        }, (err) => {
          console.error("[EDITOR FIRESTORE] onSnapshot error:", err);
        });

        return unsub;
      };

      return true;
    } catch (e) {
      console.error("[EDITOR FIRESTORE] init failed:", e);
      window.__flipboardFirestoreError = e;
      throw e;
    }
  })();
</script>

<script>
/* ============================================================
   Dummy data (fallback + optional local testing)
============================================================ */
const DUMMY_STAGE_PACK = {
  "meta": {
    "grid": { "columns": 20, "rows": 8 },
    "description": "Split-flap dashboard stage definitions"
  },
  "rotation": {
    "enabled": true,
    "dwell_ms": 15000,
    "order": ["stage_1", "stage_2", "stage_3"]
  },
  "stages": {
    "stage_1": {
      "name": "Weather",
      "type": "dynamic",
      "source": "openweather_onecall",
      "rows": [
        "BOILING SPGS SC     ",
        "{TEMP_LINE}         ",
        "{CONDITION_LINE}    ",
        "{WIND_LINE}         ",
        "                    ",
        "UPDATED: {TIME}     ",
        "                    ",
        "                    "
      ]
    },
    "stage_2": {
      "name": "Welcome Screen",
      "type": "static",
      "rows": [
        "WELCOME             ",
        "JAKE                ",
        "SMART HOME DASHBOARD",
        "                    ",
        "SPLIT FLAP DISPLAY  ",
        "                    ",
        "                    ",
        "                    "
      ]
    },
    "stage_3": {
      "name": "Today Schedule",
      "type": "static",
      "rows": [
        "4:00 PM  TUTOR E    ",
        "5-7 PM   BULLDOG    ",
        "        BALL        ",
        "7:30 PM  DINNER     ",
        "9:00 PM  WIND DOWN  ",
        "                    ",
        "                    ",
        "                    "
      ]
    },
    "stage_demo": {
      "name": "Demo Mode",
      "type": "static",
      "one_shot": true,
      "rows": [
        "DEMO MODE           ",
        "STAGE TEST          ",
        "SPLIT FLAP          ",
        "ANIMATION           ",
        "                    ",
        "                    ",
        "                    ",
        "                    "
      ]
    }
  }
};

/* ============================================================
   Utilities
============================================================ */
const deepClone = (obj) => JSON.parse(JSON.stringify(obj));
const padRight = (s, n) => (String(s ?? "") + " ".repeat(n)).slice(0, n);
const trimTo = (s, n) => String(s ?? "").slice(0, n);

function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=> el.classList.remove("show"), 1400);
}

function slugifyStageKey(s){
  return (s || "")
    .toLowerCase()
    .replace(/[^a-z0-9_]+/g, "_")
    .replace(/^_+|_+$/g, "")
    .replace(/__+/g, "_");
}

function nextStageKey(stagePack){
  let i = 1;
  while(stagePack.stages[`stage_${i}`]) i++;
  return `stage_${i}`;
}

/* ============================================================
   Wait for module globals
============================================================ */
function waitForGlobal(name, timeoutMs = 8000, pollMs = 50){
  return new Promise((resolve, reject) => {
    const start = Date.now();
    (function tick(){
      if(window[name]) return resolve(window[name]);
      if(Date.now() - start >= timeoutMs) return reject(new Error(`${name} not available after ${timeoutMs}ms`));
      setTimeout(tick, pollMs);
    })();
  });
}

/* ============================================================
   App State
============================================================ */
let stagePack = deepClone(DUMMY_STAGE_PACK);
let stagePackSaved = deepClone(stagePack);

let selectedStageKey = null;
let editorDraft = null;
let editorDraftSaved = null;

let __unsubStagePack = null;
let __didFirstRealtime = false;

function getCols(){ return stagePack?.meta?.grid?.columns ?? 20; }
function getRows(){ return stagePack?.meta?.grid?.rows ?? 8; }

/* ============================================================
   DOM refs
============================================================ */
const rotationListEl = document.getElementById("rotationList");
const otherListEl = document.getElementById("otherList");

const rotationEnabledEl = document.getElementById("rotationEnabled");
const rotationDwellEl = document.getElementById("rotationDwell");

const gridColsEl = document.getElementById("gridCols");
const gridRowsEl = document.getElementById("gridRows");
const metaDescriptionEl = document.getElementById("metaDescription");

const btnAddStage = document.getElementById("btnAddStage");
const btnRemoveStage = document.getElementById("btnRemoveStage");
const btnAddToRotation = document.getElementById("btnAddToRotation");
const btnRemoveFromRotation = document.getElementById("btnRemoveFromRotation");

const btnMoveUp = document.getElementById("btnMoveUp");
const btnMoveDown = document.getElementById("btnMoveDown");

const btnLoad = document.getElementById("btnLoad");
const btnExport = document.getElementById("btnExport");

const stageKeyEl = document.getElementById("stageKey");
const stageNameEl = document.getElementById("stageName");
const stageTypeEl = document.getElementById("stageType");
const sourceWrapEl = document.getElementById("sourceWrap");
const stageSourceEl = document.getElementById("stageSource");
const stageOneShotEl = document.getElementById("stageOneShot");

const rowsContainerEl = document.getElementById("rowsContainer");

const btnSave = document.getElementById("btnSave");
const btnCancel = document.getElementById("btnCancel");
const btnPadAll = document.getElementById("btnPadAll");
const btnTrimAll = document.getElementById("btnTrimAll");

const colsValEl = document.getElementById("colsVal");
const rowsValEl = document.getElementById("rowsVal");
const dwellValEl = document.getElementById("dwellVal");
const dirtyPillEl = document.getElementById("dirtyPill");
const colsHintEl = document.getElementById("colsHint");
const colsHint2El = document.getElementById("colsHint2");

const sourceValEl = document.getElementById("sourceVal");
const statusValEl = document.getElementById("statusVal");

function setStatus(source, status, state){
  if(sourceValEl) sourceValEl.textContent = source || "—";

  if(statusValEl){
    statusValEl.textContent = status || "—";

    const pill = statusValEl.parentElement;
    pill.classList.remove("ok","warn","err");

    if(state === "ok")   pill.classList.add("ok");
    if(state === "warn") pill.classList.add("warn");
    if(state === "err")  pill.classList.add("err");
  }
}

/* ============================================================
   Dirty Tracking
============================================================ */
function packIsDirty(){
  return JSON.stringify(stagePack) !== JSON.stringify(stagePackSaved);
}
function editorIsDirty(){
  if(!editorDraft || !editorDraftSaved) return false;
  return JSON.stringify(editorDraft) !== JSON.stringify(editorDraftSaved);
}
function updateDirtyUI(){
  const dirty = packIsDirty() || editorIsDirty();
  dirtyPillEl.style.display = dirty ? "inline-flex" : "none";
}
function setHeaderMeta(){
  colsValEl.textContent = String(getCols());
  rowsValEl.textContent = String(getRows());
  dwellValEl.textContent = String(stagePack?.rotation?.dwell_ms ?? "—");
  colsHintEl.textContent = String(getCols());
  colsHint2El.textContent = String(getCols());
}

/* ============================================================
   Lists
============================================================ */
function stageLabel(key){
  const s = stagePack.stages[key];
  const name = s?.name || "(unnamed)";
  return { name, key };
}

function makeStageItem(key, inRotation){
  const s = stagePack.stages[key];
  const { name } = stageLabel(key);

  const item = document.createElement("div");
  item.className = "stageItem" + (key === selectedStageKey ? " selected" : "");
  item.dataset.key = key;

  if(inRotation) item.setAttribute("draggable", "true");

  const top = document.createElement("div");
  top.className = "stageTop";

  const left = document.createElement("div");
  const title = document.createElement("div");
  title.className = "stageName";
  title.textContent = name;

  const sub = document.createElement("div");
  sub.className = "stageKey";
  sub.textContent = key;

  left.appendChild(title);
  left.appendChild(sub);

  const badges = document.createElement("div");
  badges.className = "badges";

  const typeBadge = document.createElement("div");
  typeBadge.className = "badge " + (s?.type === "dynamic" ? "dynamic" : "");
  typeBadge.textContent = s?.type || "static";
  badges.appendChild(typeBadge);

  if(s?.one_shot){
    const one = document.createElement("div");
    one.className = "badge oneshot";
    one.textContent = "one-shot";
    badges.appendChild(one);
  }

  top.appendChild(left);
  top.appendChild(badges);
  item.appendChild(top);

  item.addEventListener("click", () => attemptSelectStage(key));

  if(inRotation){
    item.addEventListener("dragstart", (e) => {
      item.classList.add("dragging");
      e.dataTransfer.setData("text/plain", key);
      e.dataTransfer.effectAllowed = "move";
    });
    item.addEventListener("dragend", () => {
      item.classList.remove("dragging");
      [...rotationListEl.querySelectorAll(".dropTarget")].forEach(el => el.classList.remove("dropTarget"));
    });
    item.addEventListener("dragover", (e) => {
      e.preventDefault();
      item.classList.add("dropTarget");
      e.dataTransfer.dropEffect = "move";
    });
    item.addEventListener("dragleave", () => item.classList.remove("dropTarget"));
    item.addEventListener("drop", (e) => {
      e.preventDefault();
      item.classList.remove("dropTarget");
      const fromKey = e.dataTransfer.getData("text/plain");
      const toKey = key;
      if(!fromKey || fromKey === toKey) return;
      reorderRotation(fromKey, toKey);
    });
  }

  return item;
}

function renderLists(){
  rotationListEl.innerHTML = "";
  otherListEl.innerHTML = "";

  const order = stagePack.rotation?.order ?? [];
  const inRotation = new Set(order);

  order.forEach(k => {
    if(stagePack.stages[k]) rotationListEl.appendChild(makeStageItem(k, true));
  });

  Object.keys(stagePack.stages)
    .filter(k => !inRotation.has(k))
    .sort()
    .forEach(k => otherListEl.appendChild(makeStageItem(k, false)));

  btnRemoveStage.disabled = !selectedStageKey;
  btnAddToRotation.disabled = !selectedStageKey || inRotation.has(selectedStageKey);
  btnRemoveFromRotation.disabled = !selectedStageKey || !inRotation.has(selectedStageKey);

  if(!selectedStageKey || !inRotation.has(selectedStageKey)){
    btnMoveUp.disabled = true;
    btnMoveDown.disabled = true;
  }else{
    const idx = order.indexOf(selectedStageKey);
    btnMoveUp.disabled = idx <= 0;
    btnMoveDown.disabled = idx < 0 || idx >= order.length - 1;
  }

  updateDirtyUI();
}

/* ============================================================
   Rotation reorder
============================================================ */
function reorderRotation(fromKey, toKey){
  const order = [...(stagePack.rotation?.order ?? [])];
  const fromIdx = order.indexOf(fromKey);
  const toIdx = order.indexOf(toKey);
  if(fromIdx < 0 || toIdx < 0) return;

  order.splice(fromIdx, 1);
  order.splice(toIdx, 0, fromKey);
  stagePack.rotation.order = order;

  renderLists();
  setHeaderMeta();
  updateDirtyUI();
  toast("Rotation order updated");
}

function moveSelectedInRotation(delta){
  if(!selectedStageKey) return;

  const order = [...(stagePack.rotation?.order ?? [])];
  const idx = order.indexOf(selectedStageKey);
  if(idx < 0) return;

  const nextIdx = idx + delta;
  if(nextIdx < 0 || nextIdx >= order.length) return;

  const tmp = order[nextIdx];
  order[nextIdx] = order[idx];
  order[idx] = tmp;

  stagePack.rotation.order = order;

  renderLists();
  setHeaderMeta();
  updateDirtyUI();
  toast(delta < 0 ? "Moved up" : "Moved down");
}

/* ============================================================
   Editor select / dirty prompt
============================================================ */
function attemptSelectStage(key){
  if(key === selectedStageKey) return;

  if(editorIsDirty()){
    const ok = confirm("You have unsaved changes for the current stage.\n\nOK = discard changes and switch stage.\nCancel = stay here.");
    if(!ok) return;
  }
  selectStage(key);
}

function selectStage(key){
  selectedStageKey = key;

  const stage = stagePack.stages[key];
  if(!stage){
    clearEditor();
    renderLists();
    return;
  }

  editorDraft = deepClone(stage);

  const r = getRows();
  const c = getCols();

  editorDraft.rows = Array.from({length:r}, (_,i) => {
    const val = (editorDraft.rows && editorDraft.rows[i] != null) ? String(editorDraft.rows[i]) : "";
    return padRight(val, c);
  });

  editorDraftSaved = deepClone(editorDraft);

  stageKeyEl.value = key;
  stageNameEl.value = editorDraft.name ?? "";
  stageTypeEl.value = editorDraft.type ?? "static";
  stageOneShotEl.checked = !!editorDraft.one_shot;

  if((editorDraft.type ?? "static") === "dynamic"){
    sourceWrapEl.style.display = "";
    stageSourceEl.value = editorDraft.source ?? "";
  }else{
    sourceWrapEl.style.display = "none";
    stageSourceEl.value = "";
  }

  renderRowsInputs();
  renderLists();
  setEditorButtons();
}

function clearEditor(){
  selectedStageKey = null;
  editorDraft = null;
  editorDraftSaved = null;

  stageKeyEl.value = "";
  stageNameEl.value = "";
  stageTypeEl.value = "static";
  stageSourceEl.value = "";
  stageOneShotEl.checked = false;
  sourceWrapEl.style.display = "none";
  rowsContainerEl.innerHTML = "";

  setEditorButtons();
}

function setEditorButtons(){
  const dirty = editorIsDirty();
  btnSave.disabled = !selectedStageKey || !dirty;
  btnCancel.disabled = !selectedStageKey || !dirty;
  updateDirtyUI();
}

/* ============================================================
   Row inputs
============================================================ */
function renderRowsInputs(){
  rowsContainerEl.innerHTML = "";
  const cols = getCols();
  const rows = getRows();

  for(let i=0;i<rows;i++){
    const line = editorDraft.rows[i] ?? "";

    const wrap = document.createElement("div");
    wrap.className = "lineRow";

    const lbl = document.createElement("div");
    lbl.className = "lbl";
    lbl.textContent = `ROW ${i+1}`;

    const inp = document.createElement("input");
    inp.type = "text";
    inp.value = line;
    inp.maxLength = cols;
    inp.spellcheck = false;
    inp.autocomplete = "off";

    const count = document.createElement("div");
    count.className = "count";
    count.textContent = `${String(inp.value.length).padStart(2,"0")}/${cols}`;

    inp.addEventListener("paste", (e) => {
      const clip = (e.clipboardData || window.clipboardData).getData("text") || "";
      const selStart = inp.selectionStart ?? inp.value.length;
      const selEnd = inp.selectionEnd ?? inp.value.length;
      const nextLen = (inp.value.length - (selEnd - selStart)) + clip.length;
      if(nextLen > cols){
        inp.classList.add("flashOver");
        setTimeout(()=> inp.classList.remove("flashOver"), 350);
      }
    });

    inp.addEventListener("input", () => {
      editorDraft.rows[i] = inp.value;
      count.textContent = `${String(inp.value.length).padStart(2,"0")}/${cols}`;
      onDraftChanged();
    });

    inp.addEventListener("blur", () => {
      const padded = padRight(inp.value, cols);
      editorDraft.rows[i] = padded;
      inp.value = padded;
      count.textContent = `${String(inp.value.length).padStart(2,"0")}/${cols}`;
      onDraftChanged();
    });

    wrap.appendChild(lbl);
    wrap.appendChild(inp);
    wrap.appendChild(count);
    rowsContainerEl.appendChild(wrap);
  }

  stageNameEl.oninput = () => { editorDraft.name = stageNameEl.value; onDraftChanged(); };
  stageTypeEl.onchange = () => {
    editorDraft.type = stageTypeEl.value;
    if(stageTypeEl.value === "dynamic"){
      sourceWrapEl.style.display = "";
      editorDraft.source = stageSourceEl.value || editorDraft.source || "";
    }else{
      sourceWrapEl.style.display = "none";
      delete editorDraft.source;
    }
    onDraftChanged();
  };
  stageSourceEl.oninput = () => { editorDraft.source = stageSourceEl.value; onDraftChanged(); };
  stageOneShotEl.onchange = () => { editorDraft.one_shot = !!stageOneShotEl.checked; onDraftChanged(); };
}

function onDraftChanged(){
  setEditorButtons();
  renderLists();
}

/* ============================================================
   Save / Cancel stage edits
============================================================ */
function saveStageEdits(){
  if(!selectedStageKey || !editorDraft) return;

  const cols = getCols();
  const rows = getRows();

  const normalized = deepClone(editorDraft);
  normalized.rows = Array.from({length:rows}, (_,i) => padRight(String(normalized.rows[i] ?? ""), cols));

  if(!normalized.name || !String(normalized.name).trim()){
    normalized.name = selectedStageKey;
  }

  if((normalized.type ?? "static") !== "dynamic"){
    delete normalized.source;
  }

  stagePack.stages[selectedStageKey] = normalized;

  editorDraft = deepClone(normalized);
  editorDraftSaved = deepClone(normalized);

  setEditorButtons();
  renderLists();
  setHeaderMeta();
  toast("Stage saved");
}

function cancelStageEdits(){
  if(!selectedStageKey || !editorDraftSaved) return;
  editorDraft = deepClone(editorDraftSaved);
  selectStage(selectedStageKey);
  toast("Changes discarded");
}

/* ============================================================
   Stage CRUD
============================================================ */
function addStage(){
  if(editorIsDirty()){
    const ok = confirm("You have unsaved changes.\n\nOK = discard them and add a stage.\nCancel = stay here.");
    if(!ok) return;
  }

  const keyDefault = nextStageKey(stagePack);
  const keyInput = prompt("New stage key (ID):", keyDefault);
  if(keyInput === null) return;

  const key = slugifyStageKey(keyInput) || keyDefault;
  if(stagePack.stages[key]){
    alert("That stage key already exists.");
    return;
  }

  const name = prompt("Stage name (label shown in editor):", "New Stage") ?? "New Stage";
  const typePrompt = (prompt("Stage type: static or dynamic", "static") ?? "static").toLowerCase();
  const type = (typePrompt === "dynamic") ? "dynamic" : "static";

  const cols = getCols();
  const rows = getRows();
  const rowsArr = Array.from({length:rows}, () => " ".repeat(cols));

  const newStage = { name, type, rows: rowsArr };
  if(type === "dynamic"){
    newStage.source = prompt("Dynamic source:", "openweather_onecall") ?? "openweather_onecall";
  }

  stagePack.stages[key] = newStage;

  const addToRot = confirm("Add this stage to rotation order?");
  if(addToRot){
    stagePack.rotation.order.push(key);
  }

  selectStage(key);
  renderLists();
  toast("Stage added");
}

function removeStage(){
  if(!selectedStageKey) return;

  const key = selectedStageKey;
  const stageName = stagePack.stages[key]?.name || key;

  const ok = confirm(`Delete stage "${stageName}" (${key})?\n\nThis cannot be undone.`);
  if(!ok) return;

  delete stagePack.stages[key];
  stagePack.rotation.order = (stagePack.rotation.order || []).filter(k => k !== key);

  clearEditor();
  renderLists();
  toast("Stage removed");
}

function addSelectedToRotation(){
  if(!selectedStageKey) return;
  const order = stagePack.rotation.order || [];
  if(order.includes(selectedStageKey)) return;
  order.push(selectedStageKey);
  stagePack.rotation.order = order;
  renderLists();
  toast("Added to rotation");
}

function removeSelectedFromRotation(){
  if(!selectedStageKey) return;
  stagePack.rotation.order = (stagePack.rotation.order || []).filter(k => k !== selectedStageKey);
  renderLists();
  toast("Removed from rotation");
}

/* ============================================================
   Global controls
============================================================ */
function bindRotationControls(){
  rotationEnabledEl.onchange = () => {
    stagePack.rotation.enabled = !!rotationEnabledEl.checked;
    updateDirtyUI();
  };
  rotationDwellEl.oninput = () => {
    stagePack.rotation.dwell_ms = Number(rotationDwellEl.value || 0);
    dwellValEl.textContent = String(stagePack.rotation.dwell_ms);
    updateDirtyUI();
  };
}

function bindGlobalGridControls(){
  gridColsEl.oninput = () => {
    const v = Math.max(1, Math.min(120, Number(gridColsEl.value || 1)));
    stagePack.meta.grid.columns = v;

    for(const k of Object.keys(stagePack.stages)){
      const st = stagePack.stages[k];
      st.rows = (st.rows || []).map(r => padRight(String(r ?? ""), v));
    }

    setHeaderMeta();
    if(selectedStageKey) selectStage(selectedStageKey);
    renderLists();
    updateDirtyUI();
  };

  gridRowsEl.oninput = () => {
    const v = Math.max(1, Math.min(40, Number(gridRowsEl.value || 1)));
    stagePack.meta.grid.rows = v;

    const cols = getCols();
    for(const k of Object.keys(stagePack.stages)){
      const st = stagePack.stages[k];
      const old = Array.isArray(st.rows) ? st.rows : [];
      st.rows = Array.from({length:v}, (_,i) => padRight(String(old[i] ?? ""), cols));
    }

    setHeaderMeta();
    if(selectedStageKey) selectStage(selectedStageKey);
    renderLists();
    updateDirtyUI();
  };

  metaDescriptionEl.oninput = () => {
    stagePack.meta.description = metaDescriptionEl.value;
    updateDirtyUI();
  };
}

/* ============================================================
   Pad / Trim helpers
============================================================ */
function padAllRows(){
  if(!editorDraft) return;
  const cols = getCols();
  editorDraft.rows = editorDraft.rows.map(r => padRight(String(r ?? ""), cols));
  selectStage(selectedStageKey);
  toast("Rows padded");
}
function trimAllRows(){
  if(!editorDraft) return;
  const cols = getCols();
  editorDraft.rows = editorDraft.rows.map(r => trimTo(String(r ?? ""), cols));
  selectStage(selectedStageKey);
  toast("Rows trimmed");
}

/* ============================================================
   Export / Load (dummy button)
============================================================ */
async function exportJSON(){
  const cols = getCols();
  const rows = getRows();

  const out = deepClone(stagePack);
  for(const k of Object.keys(out.stages)){
    const st = out.stages[k];
    st.name = st.name ?? k;
    st.type = st.type ?? "static";
    st.rows = Array.from({length:rows}, (_,i) => padRight(String((st.rows && st.rows[i]) ?? ""), cols));
    if(st.type !== "dynamic") delete st.source;
  }

  const text = JSON.stringify(out, null, 2);
  await navigator.clipboard.writeText(text);
  toast("JSON copied to clipboard");
}

async function loadDummy(){
  if(editorIsDirty()){
    const ok = confirm("You have unsaved changes.\n\nOK = discard and load dummy.\nCancel = stay here.");
    if(!ok) return;
  }

  stagePack = deepClone(DUMMY_STAGE_PACK);
  stagePackSaved = deepClone(stagePack);

  selectedStageKey = null;
  editorDraft = null;
  editorDraftSaved = null;

  initFromStagePack();
  setStatus("dummy", "loaded via button", "warn");
  toast("Loaded dummy data");
}

/* ============================================================
   Splitter resize
============================================================ */
(function enableSplitter(){
  const app = document.getElementById("appSplit");
  const splitter = document.getElementById("splitter");
  if(!app || !splitter) return;

  let dragging = false;

  splitter.addEventListener("mousedown", () => {
    dragging = true;
    document.body.style.userSelect = "none";
    document.body.style.cursor = "col-resize";
  });

  window.addEventListener("mousemove", (e) => {
    if(!dragging) return;
    const rect = app.getBoundingClientRect();
    const minLeft = 240;
    const maxLeft = 520;
    let leftWidth = e.clientX - rect.left;
    leftWidth = Math.max(minLeft, Math.min(maxLeft, leftWidth));
    app.style.gridTemplateColumns = `${leftWidth}px 8px 1fr`;
  });

  window.addEventListener("mouseup", () => {
    if(!dragging) return;
    dragging = false;
    document.body.style.userSelect = "";
    document.body.style.cursor = "";
  });
})();

/* ============================================================
   Initialization
============================================================ */
function initFromStagePack(){
  stagePack.meta ||= { grid: { columns: 20, rows: 8 } };
  stagePack.meta.grid ||= { columns: 20, rows: 8 };
  stagePack.rotation ||= { enabled:true, dwell_ms:15000, order:[] };
  stagePack.rotation.order ||= [];
  stagePack.stages ||= {};

  rotationEnabledEl.checked = !!stagePack.rotation.enabled;
  rotationDwellEl.value = stagePack.rotation.dwell_ms ?? 15000;

  gridColsEl.value = getCols();
  gridRowsEl.value = getRows();
  metaDescriptionEl.value = stagePack?.meta?.description ?? "";

  setHeaderMeta();
  renderLists();

  const first = (stagePack.rotation.order || []).find(k => stagePack.stages[k]);
  if(first) selectStage(first);
  else clearEditor();
}

/* ============================================================
   Event wiring
============================================================ */
btnSave.addEventListener("click", async () => {
  saveStageEdits();

  try{
    await waitForGlobal("__flipboardFirestoreReady", 8000, 50);
    await window.__flipboardFirestoreReady;

    if(window.saveStagePack){
      await window.saveStagePack(stagePack);
      stagePackSaved = deepClone(stagePack);
      updateDirtyUI();

      setStatus("firestore:server", "saved", "ok");
      toast("Saved to Firestore");
    }else{
      throw new Error("saveStagePack() missing");
    }
  }catch(err){
    setStatus("firestore", String(err?.message || err), "err");
    alert(String(err?.message || err));
  }
});

btnCancel.addEventListener("click", cancelStageEdits);

btnAddStage.addEventListener("click", addStage);
btnRemoveStage.addEventListener("click", removeStage);
btnAddToRotation.addEventListener("click", addSelectedToRotation);
btnRemoveFromRotation.addEventListener("click", removeSelectedFromRotation);

btnMoveUp.addEventListener("click", () => moveSelectedInRotation(-1));
btnMoveDown.addEventListener("click", () => moveSelectedInRotation(1));

btnPadAll.addEventListener("click", padAllRows);
btnTrimAll.addEventListener("click", trimAllRows);

btnExport.addEventListener("click", exportJSON);
btnLoad.addEventListener("click", loadDummy);

bindRotationControls();
bindGlobalGridControls();

/* ============================================================
   Firestore bootstrap + realtime stagePack subscribe
============================================================ */
(async () => {
  setStatus("starting", "loading…", "warn");

  try{
    await waitForGlobal("__flipboardFirestoreReady", 8000, 50);
    await window.__flipboardFirestoreReady;

    if(!window.loadStagePack){
      setStatus("dummy", "loadStagePack() missing", "err");
      stagePack = deepClone(DUMMY_STAGE_PACK);
      stagePackSaved = deepClone(stagePack);
      initFromStagePack();
      toast("loadStagePack missing — using dummy");
      return;
    }

    // Initial load
    stagePack = await window.loadStagePack();
    stagePackSaved = deepClone(stagePack);

    selectedStageKey = null;
    editorDraft = null;
    editorDraftSaved = null;

    initFromStagePack();

    const initialSrc = window.__flipboardLastSource || "firestore";
    setStatus(initialSrc, "loaded", String(initialSrc).includes("server") ? "ok" : "warn");
    toast("Loaded from Firestore");

    // Realtime subscribe (matches Flipboard display)
    if (__unsubStagePack) { try { __unsubStagePack(); } catch(_){} }
    if (typeof window.subscribeStagePack === "function") {
      __unsubStagePack = window.subscribeStagePack((incomingPack, src) => {
        // Don't clobber active edits
        if (packIsDirty() || editorIsDirty()) {
          setStatus(src || "firestore", "remote update (unsaved changes)", "warn");
          toast("Remote update detected — save/cancel to refresh");
          return;
        }

        stagePack = incomingPack;
        stagePackSaved = deepClone(incomingPack);

        selectedStageKey = null;
        editorDraft = null;
        editorDraftSaved = null;

        initFromStagePack();

        const state = String(src || "").includes("server") ? "ok" : "warn";
        if (!__didFirstRealtime) {
          __didFirstRealtime = true;
          setStatus(src || "firestore", "realtime OK", state);
        } else {
          setStatus(src || "firestore", "updated", state);
        }
      });
      console.log("[EDITOR] realtime subscribed ✅");
    } else {
      console.warn("[EDITOR] subscribeStagePack missing — no realtime");
    }

  }catch(err){
    const msg = String(err?.message || err);
    console.error("[EDITOR] Firestore bootstrap failed:", err);

    setStatus("dummy", msg, "err");

    stagePack = deepClone(DUMMY_STAGE_PACK);
    stagePackSaved = deepClone(stagePack);
    initFromStagePack();
    toast("Firestore load failed — using dummy");
  }
})();
</script>
</body>
</html>
```0
